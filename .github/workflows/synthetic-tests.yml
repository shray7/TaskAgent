# Synthetic checks for staging and production.
name: Synthetic Tests

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PRODUCTION_URL: https://taskagent-api.azurecontainerapps.io
  STAGING_URL: https://taskagent-api-staging.azurecontainerapps.io

jobs:
  synthetic-tests:
    name: Synthetic Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [staging, production]
    steps:
      - uses: actions/checkout@v4

      - name: Set environment URL
        id: env
        run: |
          if [ "${{ matrix.environment }}" == "production" ]; then
            echo "url=${{ env.PRODUCTION_URL }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ env.STAGING_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Health check (readiness)
        run: |
          response=$(curl -sf -w "%{http_code}" "${{ steps.env.outputs.url }}/health/ready" -o /tmp/health.json)
          if [ "$response" != "200" ]; then
            echo "‚ùå Health check failed with status $response"
            cat /tmp/health.json || true
            exit 1
          fi
          echo "‚úÖ Health check passed"
          cat /tmp/health.json

      - name: API - Response time check
        run: |
          total_time=$(curl -sf -w "%{time_total}" -o /dev/null "${{ steps.env.outputs.url }}/health/ready")
          echo "Response time: ${total_time}s"
          if (( $(echo "$total_time > 2.0" | bc -l) )); then
            echo "‚ùå Response time too slow: ${total_time}s > 2.0s"
            exit 1
          fi
          echo "‚úÖ Response time acceptable"

      - name: Swagger availability
        run: |
          response=$(curl -sf -w "%{http_code}" "${{ steps.env.outputs.url }}/swagger/v1/swagger.json" -o /dev/null)
          if [ "$response" != "200" ]; then
            echo "‚ùå Swagger endpoint unavailable"
            exit 1
          fi
          echo "‚úÖ Swagger available"

  notify-on-failure:
    name: Notify on Failure
    needs: synthetic-tests
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Synthetic tests failed - ${new Date().toISOString()}`;
            const body = `
            ## Synthetic Test Failure

            **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Time:** ${new Date().toISOString()}

            Please investigate the failing tests.
            `;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'synthetic-test-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['synthetic-test-failure', 'bug']
              });
            }
