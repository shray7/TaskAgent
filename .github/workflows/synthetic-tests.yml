# Synthetic checks for staging and production.
# Configure URLs: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables
# - STAGING_API_URL: e.g. https://taskagent-api-staging.<env-id>.eastus.azurecontainerapps.io
# - PRODUCTION_API_URL: e.g. https://taskagent-api.<env-id>.eastus.azurecontainerapps.io
# Get FQDN from: az containerapp show --name <app> --resource-group rg-taskagent --query "properties.configuration.ingress.fqdn" -o tsv
name: Synthetic Tests

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  synthetic-tests:
    name: Synthetic Tests (${{ matrix.environment }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Production disabled for now; re-enable with ["staging", "production"] when PRODUCTION_API_URL is set
        environment: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.environment)) || fromJSON('["staging"]') }}
    steps:
      - uses: actions/checkout@v4

      - name: Set environment URL
        id: env
        run: |
          if [ "${{ matrix.environment }}" == "production" ]; then
            url="${{ vars.PRODUCTION_API_URL }}"
          else
            url="${{ vars.STAGING_API_URL }}"
          fi
          if [ -z "$url" ]; then
            echo "::error::${{ matrix.environment }} API URL is not set. Add vars.STAGING_API_URL and vars.PRODUCTION_API_URL in Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables."
            echo "Example: https://taskagent-api-staging.<env-id>.eastus.azurecontainerapps.io"
            exit 1
          fi
          echo "url=$url" >> $GITHUB_OUTPUT

      - name: Health check (readiness)
        run: |
          url="${{ steps.env.outputs.url }}"
          set +e
          response=$(curl -sf -w "%{http_code}" -o /tmp/health.json "$url/health/ready" 2>/dev/null)
          curl_exit=$?
          set -e
          if [ -z "$response" ]; then
            echo "::error::curl failed (exit $curl_exit). Exit 6 = DNS resolution failed."
            echo "Ensure vars.STAGING_API_URL and vars.PRODUCTION_API_URL are set in repo Settings."
            exit 1
          fi
          if [ "$response" != "200" ]; then
            echo "‚ùå Health check failed with status $response"
            cat /tmp/health.json || true
            exit 1
          fi
          echo "‚úÖ Health check passed"
          cat /tmp/health.json

      - name: API - Response time check
        run: |
          total_time=$(curl -sf -w "%{time_total}" -o /dev/null "${{ steps.env.outputs.url }}/health/ready")
          echo "Response time: ${total_time}s"
          if (( $(echo "$total_time > 2.0" | bc -l) )); then
            echo "‚ùå Response time too slow: ${total_time}s > 2.0s"
            exit 1
          fi
          echo "‚úÖ Response time acceptable"

      - name: Swagger availability
        run: |
          response=$(curl -sf -w "%{http_code}" "${{ steps.env.outputs.url }}/swagger/v1/swagger.json" -o /dev/null)
          if [ "$response" != "200" ]; then
            echo "‚ùå Swagger endpoint unavailable"
            exit 1
          fi
          echo "‚úÖ Swagger available"

  notify-on-failure:
    name: Notify on Failure
    needs: synthetic-tests
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Synthetic tests failed - ${new Date().toISOString()}`;
            const body = `
            ## Synthetic Test Failure

            **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Time:** ${new Date().toISOString()}

            Please investigate the failing tests.
            `;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'synthetic-test-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['synthetic-test-failure', 'bug']
              });
            }
